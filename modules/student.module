<?php
/**
 * Created by PhpStorm.
 * User: Andrew Quaye
 * Date: 07/11/2018
 * Time: 11:31 AM
 */


class PROFILE{

    function password($conn){

         $id = $_SESSION['studentID'];
        $token = $_SESSION['token'];
        $username = $_POST['username'];
        $password = $_POST['password'];
        $mobile = $_POST['mobile'];
        $email = $_POST['email'];
        $stamp = md5($username."/".$password);

        $sql ="UPDATE `get_all_pins` SET 
            `username` = '$username', 
            `password` = '$password', 
            `mobile` = '$mobile', 
            `email` = '$email', 
            `token` = '$stamp' 
            WHERE `token` = '$token'";
        $result = (mysqli_query($conn,$sql));
        if ($result == TRUE){
            $sql = "UPDATE `student_profile` SET `token` = '$stamp' WHERE `studentID` = '$id'";
            $result = (mysqli_query($conn,$sql));
            if ($result == TRUE){
                $_SESSION['token'] = $stamp;
                setcookie("token",$stamp,time() + (86400 * 30), "/");

                header("location: index.php?_route=student&p=password&e=104");
            }else{
                header("location: index.php?_route=student&p=password&e=103");
            }
        }
    }

    public function update($conn){

        $id = $_SESSION['studentID'];
        $date= date ("Y-m-d");
        $f_name = $_POST['f-name'];
        $l_name = $_POST['l-name'];
        $dob = $_POST['dob'];
        $gender = $_POST['gender'];
        $marital = $_POST['marital-status'];
        $nationality = $_POST['nationality'];
        $address = $_POST['address'];
        $admission = $_POST['admission'];
        $mobile = $_POST['mobile-1'];
        $mobile2 =$_POST['mobile-2'];
        $email = $_POST['email'];
        $campus_status = $_POST['hostel'];
        $yearID = $_POST['year'];
        $progID = $_POST['programme'];
        $categoryID = $_POST['category'];
        $stream = $_POST['stream'];
        $application = $_POST['entry'];

        $sql="UPDATE `student_profile` SET 
              `entryID` = '$application',
              `serial_no` = '2', 
              `admissionDate` = '$date',
              `first_name` = '$f_name', 
              `surname` = '$l_name', 
              `admissionNo` = '$admission', 
              `dob` = '$dob',
              `gender` = '$gender',
              `nationalityID` = '$nationality',
              `marital_status` = '$marital',
              `mobile1` = '$mobile',
              `mobile2` = '$mobile2',
              `email` = '$email',
              `address` = '$address',
              `progID` = '$progID',
              `yearID` = '$yearID',
              `categoryID` = '$categoryID',
              `streamID` = '$stream',
              `campus_status` = '$campus_status'
               WHERE `studentID` = '$id'";
        $result = (mysqli_query($conn,$sql));

        if ($result == TRUE){
            header("location: index.php?_route=student&p=update&e=104");
        }else{
            header("location: index.php?_route=student&p=profile&e=103");
        }
    }

    function upload_picture($conn){

        $id = $_SESSION['studentID'];
        $target_dir = "asset/uploads/student/";
        $target_file = $target_dir . basename($_FILES["fileToUpload"]["name"]);
        $uploadOk = 1;

        $imageFileType = strtolower(pathinfo($target_file,PATHINFO_EXTENSION));
        // Check if image file is a actual image or fake image
        if(isset($_POST["submit"])) {
            $check = getimagesize($_FILES["fileToUpload"]["tmp_name"]);
            if($check !== false) {
                echo "File is an image - " . $check["mime"] . ".";
                $uploadOk = 1;
            } else {
                echo "File is not an image.";
                $uploadOk = 0;
            }
        }
        // Check if file already exists
        if (file_exists($target_file)) {
            $file = md5($target_file."/". uniqid());
            $target_file ="asset/uploads/student/". $file.".jpeg";
            //echo "Sorry, file already exists.";
            $uploadOk = 1;
        }
        // Check file size
        if ($_FILES["fileToUpload"]["size"] > 500000) {
            echo "Sorry, your file is too large.";
            $uploadOk = 0;
        }
        // Allow certain file formats
        if($imageFileType != "jpg" && $imageFileType != "png" && $imageFileType != "jpeg"
            && $imageFileType != "gif" ) {
            echo "Sorry, only JPG, JPEG, PNG & GIF files are allowed.";
            $uploadOk = 0;
        }
        // Check if $uploadOk is set to 0 by an error
        if ($uploadOk == 0) {
            echo "Sorry, your file was not uploaded.";
        // if everything is ok, try to upload file
        } else {
            if (move_uploaded_file($_FILES["fileToUpload"]["tmp_name"], $target_file)) {
                //echo "The file ". basename( $_FILES["fileToUpload"]["name"]). " has been uploaded.";
                $sql ="UPDATE `student_profile` SET `picture`='$target_file' WHERE (`studentID`='$id ')";
                $result = $conn->query($sql);

                if ($result == TRUE) {
                    $_SESSION['image'] = $target_file;
                    $_SESSION['pic-status'] = true;
                    header("location: ?_route=student&p=dashboard&e=104");
                }
            } else {
                echo "Sorry, there was an error uploading your file.";
                $_SESSION['pic-status'] = null;
            }
        }

    }

    public function delete(){
        //$id = $_SESSION['studentID'];
    }


}